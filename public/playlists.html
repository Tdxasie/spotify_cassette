<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Your Playlists</title>
	<link rel="stylesheet" href="styles.css">
</head>

<body>
	<h1>Your Spotify Playlists</h1>
	<ul id="playlists"></ul>
	<div id="tracks" style="display:none;">
		<button onclick="goBack()">Back to Playlists</button>
		<h2 id="playlist-name"></h2>
		<ul id="tracklist"></ul>
	</div>
	<script type="module">
		const params = new URLSearchParams(window.location.search);
		const token = params.get('access_token');

		async function fetchPlaylists() {
			const res = await fetch('https://api.spotify.com/v1/me/playlists', {
				headers: {
					Authorization: `Bearer ${token}`
				}
			});
			if (!res.ok) {
				document.body.innerHTML = '<p>Authorization failed. Please try again.</p>';
				return;
			}
			const data = await res.json();
			const ul = document.getElementById('playlists');
			data.items.forEach(pl => {
				const li = document.createElement('li');
				const a = document.createElement('a');
				a.href = '#';
				a.onclick = () => showTracks(pl.id, pl.name);

				const thumbnail = pl.images && pl.images.length > 0 ? pl.images[0].url : '';

				a.innerHTML = `
					<div class="playlist-info">
						<div class="playlist-thumbnail">
							${thumbnail ? `<img src="${thumbnail}" alt="${pl.name}">` : '<div class="no-image">♪</div>'}
						</div>
						<div class="playlist-details">
							<div class="playlist-name">${pl.name}</div>
							<div class="playlist-meta">
								<span class="track-count">${pl.tracks.total} tracks</span>
							</div>
						</div>
					</div>
				`;

				li.appendChild(a);
				ul.appendChild(li);
			});
		}

		let currentTracks = [];
		let currentPlaylistId = '';

		async function showTracks(playlistId, playlistName) {
			currentPlaylistId = playlistId;
			document.getElementById('playlists').style.display = 'none';
			document.getElementById('tracks').style.display = 'block';
			document.getElementById('playlist-name').textContent = playlistName;

			const res = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
				headers: {
					Authorization: `Bearer ${token}`
				}
			});

			const data = await res.json();
			currentTracks = data.items.filter(item => item.track);
			renderTracks();
		}

		function renderTracks() {
			const ul = document.getElementById('tracklist');
			ul.innerHTML = '';

			let cumulativeMs = 0;
			let added45MinDivider = false;

			currentTracks.forEach((item, index) => {
				const track = item.track;
				const durationMs = track.duration_ms;
				cumulativeMs += durationMs;

				// Check if we need to add 45min divider
				if (!added45MinDivider && cumulativeMs >= 45 * 60 * 1000) {
					const divider = document.createElement('li');
					divider.innerHTML = '<hr><strong>45 MINUTE MARK</strong><hr>';
					ul.appendChild(divider);
					added45MinDivider = true;
				}

				const li = document.createElement('li');
				li.draggable = true;
				li.dataset.index = index;
				const trackDuration = formatDuration(durationMs);
				const cumulativeDuration = formatDuration(cumulativeMs);

				const albumImage = track.album.images && track.album.images.length > 0 ? track.album.images[track.album.images.length - 1].url : '';

				li.innerHTML = `
					<div class="track-info">
						<div class="track-thumbnail">
							${albumImage ? `<img src="${albumImage}" alt="${track.album.name}">` : '<div class="no-track-image">♪</div>'}
						</div>
						<div class="track-details">
							<span class="drag-handle">⋮⋮</span>
							<div class="track-text">
								<span class="track-name">${track.name}</span>
								<span class="track-artist"> - ${track.artists.map(a => a.name).join(', ')}</span>
							</div>
						</div>
						<div class="track-controls">
							<button class="play-btn" onclick="playTrack('${track.uri}', '${track.preview_url}')" ${!track.preview_url ? 'disabled' : ''}>
								${!track.preview_url ? '⏸' : '▶'}
							</button>
						</div>
						<div class="track-times">
							<span class="track-duration">${trackDuration}</span>
							<span class="cumulative-time">${cumulativeDuration}</span>
						</div>
					</div>
				`;		

				li.addEventListener('dragstart', handleDragStart);
				li.addEventListener('dragover', handleDragOver);
				li.addEventListener('drop', handleDrop);
				li.addEventListener('dragend', handleDragEnd);

				ul.appendChild(li);
			});
		}

		let draggedElement = null;

		function handleDragStart(e) {
			draggedElement = e.target;
			e.dataTransfer.effectAllowed = 'move';
			e.target.style.opacity = '0.5';
		}

		function handleDragOver(e) {
			e.preventDefault();
			e.dataTransfer.dropEffect = 'move';
		}

		function handleDrop(e) {
			e.preventDefault();
			if (draggedElement !== e.target) {
				const draggedIndex = parseInt(draggedElement.dataset.index);
				const targetIndex = parseInt(e.target.dataset.index);

				// Move the track in the array
				const draggedTrack = currentTracks[draggedIndex];
				currentTracks.splice(draggedIndex, 1);
				currentTracks.splice(targetIndex, 0, draggedTrack);

				// Re-render with new order
				renderTracks();

				// Call API to reorder on Spotify
				reorderOnSpotify(draggedIndex, targetIndex);
			}
		}

		function handleDragEnd(e) {
			e.target.style.opacity = '1';
			draggedElement = null;
		}

		async function reorderOnSpotify(fromIndex, toIndex) {
			try {
				const insertBefore = toIndex > fromIndex ? toIndex + 1 : toIndex;
				await fetch(`https://api.spotify.com/v1/playlists/${currentPlaylistId}/tracks`, {
					method: 'PUT',
					headers: {
						'Authorization': `Bearer ${token}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						range_start: fromIndex,
						insert_before: insertBefore,
						range_length: 1
					})
				});
				console.log(`Moved track from ${fromIndex} to ${toIndex}`);
			} catch (error) {
				console.error('Failed to reorder on Spotify:', error);
			}
		}

		function formatDuration(ms) {
			const minutes = Math.floor(ms / 60000);
			const seconds = Math.floor((ms % 60000) / 1000);
			return `${minutes}:${seconds.toString().padStart(2, '0')}`;
		}

		window.goBack = function () {
			document.getElementById('tracks').style.display = 'none';
			document.getElementById('playlists').style.display = 'block';
		}

		let currentAudio = null;
			let currentPlayingButton = null;

			async function playTrack(trackUri, previewUrl) {
				const button = event.target;

				// Stop current playing track
				if (currentAudio) {
					currentAudio.pause();
					if (currentPlayingButton) {
						currentPlayingButton.textContent = '▶';
						currentPlayingButton.classList.remove('playing');
					}
				}

				if (button === currentPlayingButton) {
					// Same button clicked - stop playback
					currentAudio = null;
					currentPlayingButton = null;
					return;
				}

				if (previewUrl) {
					// Play preview (30-second clip)
					currentAudio = new Audio(previewUrl);
					currentAudio.play();
					button.textContent = '⏸';
					button.classList.add('playing');
					currentPlayingButton = button;

					currentAudio.onended = () => {
						button.textContent = '▶';
						button.classList.remove('playing');
						currentAudio = null;
						currentPlayingButton = null;
					};
				} else {
					// Try to play full track via Spotify API (requires premium)
					try {
						await fetch('https://api.spotify.com/v1/me/player/play', {
							method: 'PUT',
							headers: {
								'Authorization': `Bearer ${token}`,
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								uris: [trackUri]
							})
						});
						button.textContent = '⏸';
						button.classList.add('playing');
					} catch (error) {
						console.log('Spotify playback failed, no preview available');
					}
				}
			}

		fetchPlaylists();
	</script>
</body>

</html>